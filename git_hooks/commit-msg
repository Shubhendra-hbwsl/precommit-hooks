#!/usr/bin/env bash
# File generated by pre-commit: https://pre-commit.com
# ID: 138fd403232d2ddd5efb44317e38bf03

# start templated
INSTALL_PYTHON=/usr/bin/python3
ARGS=(hook-impl --config=.pre-commit-config.yaml --hook-type=commit-msg)
# end templated

HERE="$(cd "$(dirname "$0")" && pwd)"
ARGS+=(--hook-dir "$HERE" -- "$@")

##############################
# Commit message validation

commit_msg="${1}"
commit_msg_lines=()
error_msg="[COMMIT FAILED]"
allowed_subject_verbs=('Add' 'Create' 'Update' 'Change' 'Fix' 'Refactor' 'Clean up' 'Remove' 'Move' 'Delete' 'Resolve' 'Merge' 'Initial')

# Splits the commit msg into separate lines and adds them to an array
split_commit_msg() {
    while IFS= read -r line; do

        # Trim trailing spaces from lines
        shopt -s extglob
        line="${line%%*( )}"
        shopt -u extglob

        # Ignore comments (lines starting with #)
        if [[ ! "${line}" =~ ^# ]]; then
            commit_msg_lines+=("${line}")
        fi

    done < <(cat ${commit_msg})
}


# Validates the commit msg
validate_commit_msg() {
    split_commit_msg

    # Store the subject
    local subject="${commit_msg_lines[0]}"

    # Stop validation if the message is empty or no subject is set
    if [[ -z "${commit_msg_lines[*]}" ]] || [[ -z "${subject}" ]]; then
        exit 0
    fi

    # Check if the subject has leading whitespace(s)
    if [[ "${subject}" =~ ^[[:space:]]+ ]]; then
        echo "${error_msg} The subject can not have leading whitespace"
        exit 1;
    fi

    # Check if the subject contains more than 1 word
    if [[ $(echo "${subject}" | wc -w) -eq 1 ]]; then
        echo "${error_msg} The subject has to contain more than 1 word"
        exit 1
    fi

    # Check if the subject is separated from the body with a blank line
    if [[ ${#commit_msg_lines[@]} -gt 1 ]] && [[ -n "${commit_msg_lines[1]}" ]]; then
        echo "${error_msg} Separate subject from body with a blank line"
        exit 1
    fi

    # Check if the subject line is limited to 50 characters
    if [[ "${#subject}" -gt 50 ]]; then
        echo "${error_msg} Limit the subject line to 50 characters (${#commit_msg_lines[0]} characters used)"
        exit 1
    fi

    # Check if the subject line is capitalized
    local without_first_word=$( echo "${subject}" | cut -d ' ' -f 1 --complement)

    if [[ ! "$without_first_word" =~ ^[A-Z] ]]; then
        echo "${error_msg} Capitalize the subject line"
        exit 1
    fi

    # Check if the subject line does not end with a period
    if [[ ! "${subject}" =~ [^\.]$ ]]; then
        echo "${error_msg} Do not end the subject line with a period"
        exit 1
    fi

    # Check if the subject starts with one of the allowed verbs
    local first_word=$(echo "${subject}" | awk '{print $2;}')
    local is_allowed=false

    for verb in "${allowed_subject_verbs[@]}"; do
        if [[ "${verb}" == "${first_word}" ]]; then
            is_allowed=true
        fi
    done

    if [[ "${is_allowed}" == false ]]; then
        echo "${error_msg} Use the imperative mood in the subject line"
        echo "Your subject has to start with one of the following verbs:"
        printf -- '    - %s\n' "${allowed_subject_verbs[@]}"
        exit 1
    fi

    # Check if the body is wrapped at 72 characters (except for url's)
    for line in "${commit_msg_lines[@]}"; do
        if [[ "${line}" =~ ^[[:space:]]*(https?|ftp|file):\/\/[-A-Za-z0-9\+\&\@\#\/\%\?\=\~\_\|\!\:\,\.\;]*[-A-Za-z0-9\+\&\@\#\/\%\=\~\_\|] ]]; then
            continue
        elif [[ "${#line}" -gt 72 ]]; then
            echo "${error_msg} Wrap the body at 72 characters (${#line} characters used)"
            exit 1
        fi
    done
}

validate_commit_msg

# Remove comment lines from the message
sed -i.bak '/^#/ d' $1

# Remove trailing blank lines
sed -i.bak -e :a -e '/^\n*$/{$d;N;ba' -e '}' $1


#############################

if [ -x "$INSTALL_PYTHON" ]; then
	exec "$INSTALL_PYTHON" -mpre_commit "${ARGS[@]}"

elif command -v pre-commit > /dev/null; then
	exec pre-commit "${ARGS[@]}"

else
    echo '`pre-commit` not found.  Did you forget to activate your virtualenv?' 1>&2
    exit 1
fi
